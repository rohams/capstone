// a function to draw ellipse based on cost
function testGetEllipse(foci,map){
//set boundaries
    var COST_DST_RATIO = 0.001;
    var MAX_LAT = 62;
    var MIN_LAT = 42;
    var MAX_LNG = -101;
    var MIN_LNG = -130;
//GRANULARITY
    var GRL = 0.0002;
    var height = 0;
    var set_grl = true;
    var THERESHOLD= 0.012;
    var STEPSIZE = 0.006;
    var ellipse = [];
    var point;
    var steps;
    var thl;
    var min;
    var FW_point = new Node; 
    var cost_step = document.getElementById('coststep').value;
    var init_cost = new Cost(document.getElementById('cost').value);
    normalizeWeights();
    if (!init_cost.status()){
        alert ('Entered cost parameter is not valid!');
        return false;
    }
    var d;
    var cost = init_cost.cost;
    
    //dynamically tune the granularity based on the initial cost    
    steps = STEPSIZE;
    thl = THERESHOLD;
    //remove last drawing
        for(x in shapes){
        shapes[x].setVisible(false);
        shapes[x].setMap(map);
    }
    for (x in pathInfos){
        pathInfos[x].close(map);
    }
    
    var index = 0;
    //draw new ellipses
    while(cost>0){
        
    var dist = cost*COST_DST_RATIO; 
    var min = dist;
    var ave = getWeightedAverage(foci); 
    
    //sweep the right side
    for (i = MIN_LAT; i < MAX_LAT; i += steps) {
			for (j = ave.getLng(); j < MAX_LNG; j += steps) {
				d = SumOfDistances(foci, i, j);
                                 if (d<min){
                                    min=d;
                                    FW_point.lat = i;
                                    FW_point.lng = j;
                                }    
                                if (d>dist){
                                    break;
                                }
                                d -= dist;                                                            
                                if (Math.abs(d) < thl) {
                                    point= new Node(i,j);
                                    if(set_grl){
                                        set_grl=false;
                                        height = distance(point,ave);
                                        steps *= height/norm_weight_ave;
                                        thl*=height/norm_weight_ave;
                                    }
                                    ellipse.push(point);
                                    break;
                                }
                        }
     }
     //get the highest LAT (sweeping anything above it is unncessary)
     if(ellipse[ellipse.length-1]!=undefined)
     {
        var highest_lat = ellipse[ellipse.length-1].getLat();
     }
     //get the lowest LAT (sweeping anything below it is unncessary)
     if(ellipse[0]!=undefined)
     {
        var lowest_lat = ellipse[0].getLat();
     }     
     //sweep the left side           
     for (i = highest_lat; i > lowest_lat; i -= steps) {
			for (j = ave.getLng(); j > MIN_LNG; j -= steps) {
				d = SumOfDistances(foci, i, j);
                                if (d<min){
                                    min=d;
                                    FW_point.lat = i;
                                    FW_point.lng = j;
                                }
                                if (d>dist){
                                    break;
                                }
                                d -= dist;                                                             
                                if (Math.abs(d) < thl) {
                                    var point= new Node(i,j);
                                    ellipse.push(point); 
                                    break;
                                }				
			}
		}
                //Terminate
                if(ellipse.length==0){
                    break;
                }
                testDrawEllipse(map, ellipse, cost, index);
		index++;
                cost -= cost_step;
                ellipse = [];    
    }
                
       new google.maps.Marker({                              
                    position: new google.maps.LatLng(FW_point.getLat(), FW_point.getLng()),
                    draggable: false,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 6
                      },
                    title: 'Fermat-Weber Point',
                    zIndex: AVE_ZINDEX,
                    animation: google.maps.Animation.DROP
                    }); 
      var x="Minimum Distance: " + min + " granularity: " + steps;
      document.getElementById("panel").innerHTML=x;

    return ellipse;
}

function testDrawEllipse(map, points, cost, ellipseIndex){
    var ellipseOneLat = [[45.52200000000013, 45.583222695360135, 45.644445390720136, 45.76689078144014, 45.950558867520144, 46.07300425824015, 46.34850638736015, 46.71584255952016, 47.02195603632017, 47.236235470080175, 47.266846817760175, 47.54234894688018, 47.57296029456018, 48.460689377280204, 48.82802554944021, 48.889248244800214, 49.01169363552022, 49.07291633088022, 49.13413902624022, 49.348418460000225, 49.59330924144023, 49.807588675200236, 50.08309080432024, 50.26675889040025, 50.48103832416025, 50.78715180096026, 51.91977166512029, 52.5932213140803, 52.74627805248031, 53.20544826768032, 53.45033904912032, 54.06256600272034, 54.307456784160344, 54.42990217488035, 55.07274047616036, 55.164574519200364, 55.195185866880365, 55.225797214560366, 55.25640856224037, 55.31763125760037, 55.50129934368037, 55.562522039040374, 55.593133386720375, 55.593133386720375, 55.562522039040374, 55.53191069136037, 55.47068799600037, 55.44007664832037, 55.225797214560366, 55.164574519200364, 55.07274047616036, 55.04212912848036, 54.766626999360355, 54.64418160864035, 54.49112487024035, 54.42990217488035, 54.368679479520345, 54.21562274112034, 54.12378869808034, 54.00134330736034, 53.84828656896033, 53.511561744480325, 53.480950396800324, 53.45033904912032, 53.083002876960315, 52.89933479088031, 52.5319986187203, 52.4401645756803, 52.3483305326403, 52.256496489600295, 52.10343975120029, 51.827937622080285, 51.76671492672028, 51.70549223136028, 51.64426953600028, 51.36876740688027, 51.21571066848027, 50.75654045328026, 50.51164967184025, 49.93003406592024, 49.317807112320224, 48.950470940160216, 48.73619150640021, 48.491300724960205, 48.062741857440194, 47.695405685280186, 47.297458165440176, 47.266846817760175, 47.236235470080175, 47.205624122400174, 47.17501277472017, 47.14440142704017, 46.89951064560017, 46.77706525488016, 46.62400851648016, 46.50156312576016, 46.31789503968015, 46.28728369200015, 46.10361560592015, 45.950558867520144, 45.644445390720136, 45.613834043040136, 45.583222695360135, 45.552611347680134], [ 46.3162000228801, 46.346811370560104, 46.438645413600106, 46.46925676128011, 46.49986810896011, 46.59170215200011, 46.805981585760115, 47.02026101952012, 47.14270641024012, 47.38759719168013, 47.47943123472013, 47.601876625440134, 47.81615605920014, 47.84676740688014, 47.87737875456014, 47.90799010224014, 47.93860144992014, 47.96921279760014, 47.999824145280144, 48.030435492960144, 48.55082840352016, 48.97938727104017, 49.46916883392018, 49.62222557232018, 49.714059615360185, 49.80589365840019, 50.02017309216019, 50.3262865689602, 50.540566002720205, 50.84667947952021, 51.765019909920234, 51.795631257600235, 52.10174473440024, 52.34663551584025, 52.71397168800026, 52.86702842640026, 52.98947381712026, 53.23436459856027, 53.509866727680276, 53.72414616144028, 53.877202899840285, 53.907814247520285, 53.938425595200286, 53.96903694288029, 53.99964829056029, 54.03025963824029, 54.15270502896029, 54.275150419680294, 54.4588185057603, 54.5812638964803, 54.6118752441603, 54.6424865918403, 54.673097939520304, 54.703709287200304, 54.703709287200304, 54.5812638964803, 54.3975958104003, 54.21392772432029, 54.18331637664029, 54.15270502896029, 54.12209368128029, 54.09148233360029, 54.06087098592029, 53.907814247520285, 53.81598020448028, 53.57108942304028, 53.29558729392027, 53.14253055552027, 53.111919207840266, 52.46908090656025, 52.285412820480246, 52.13235608208024, 51.91807664832024, 51.826242605280235, 51.73440856224023, 51.428295085440226, 50.999736217920216, 50.78545678416021, 50.3262865689602, 50.2038411782402, 49.16305535712017, 48.458994360480155, 47.96921279760014, 47.693710668480136, 47.51004258240013, 47.32637449632013, 47.265151800960126, 47.203929105600125, 47.11209506256012, 46.98964967184012, 46.95903832416012, 46.92842697648012, 46.89781562880012, 46.86720428112012, 46.744758890400114, 46.65292484736011, 46.53047945664011, 46.408034065920106], [ 47.173317757920124, 47.203929105600125, 47.234540453280125, 47.265151800960126, 47.29576314864013, 47.35698584400013, 47.47943123472013, 47.54065393008013, 48.091658188320146, 48.21410357904015, 48.39777166512015, 48.428383012800154, 48.55082840352016, 48.58143975120016, 48.61205109888016, 48.82633053264016, 48.94877592336017, 49.22427805248017, 49.59161422464018, 49.95895039680019, 50.081395787520194, 50.2344525259202, 50.4181206120002, 50.4487319596802, 50.78545678416021, 50.81606813184021, 50.84667947952021, 50.87729082720021, 51.06095891328022, 51.09157026096022, 51.12218160864022, 51.15279295632022, 51.52012912848023, 51.70379721456023, 51.856853952960236, 52.10174473440024, 52.193578777440244, 52.34663551584025, 52.53030360192025, 52.71397168800026, 53.020085164800264, 53.081307860160265, 53.14253055552027, 53.38742133696027, 53.60170077072028, 53.63231211840028, 53.66292346608028, 53.69353481376028, 53.69353481376028, 53.66292346608028, 53.54047807536028, 53.509866727680276, 53.479255380000275, 53.448644032320274, 53.38742133696027, 53.32619864160027, 53.29558729392027, 53.081307860160265, 53.050696512480265, 52.95886246944026, 52.80580573104026, 52.652748992640255, 52.56091494960025, 52.43846955888025, 52.254801472800246, 52.224190125120245, 52.193578777440244, 51.91807664832024, 51.88746530064024, 51.856853952960236, 51.64257451920023, 51.48951778080023, 51.367072390080224, 50.999736217920216, 50.78545678416021, 50.4793433073602, 50.4181206120002, 50.2650638736002, 50.02017309216019, 49.80589365840019, 49.46916883392018, 49.19366670480017, 48.918164575680166, 48.67327379424016, 48.64266244656016, 48.36716031744015, 48.061046840640145, 47.999824145280144, 47.90799010224014, 47.78554471152014, 47.75493336384014, 47.72432201616014, 47.693710668480136, 47.663099320800136, 47.41820853936013, 47.32637449632013, 47.29576314864013, 47.265151800960126, 47.234540453280125], [ 48.15288088368015, 48.18349223136015, 48.21410357904015, 48.24471492672015, 48.27532627440015, 48.428383012800154, 48.489605708160155, 48.70388514192016, 48.76510783728016, 48.82633053264016, 48.918164575680166, 49.53039152928018, 49.86711635376019, 49.98956174448019, 50.2038411782402, 50.2344525259202, 50.2650638736002, 50.509954655040204, 50.540566002720205, 50.571177350400205, 50.78545678416021, 50.81606813184021, 50.938513522560214, 51.06095891328022, 51.15279295632022, 51.24462699936022, 51.30584969472022, 51.367072390080224, 51.428295085440226, 51.48951778080023, 51.58135182384023, 51.70379721456023, 51.94868799600024, 52.04052203904024, 52.10174473440024, 52.285412820480246, 52.31602416816025, 52.34663551584025, 52.37724686352025, 52.40785821120025, 52.43846955888025, 52.46908090656025, 52.46908090656025, 52.43846955888025, 52.40785821120025, 52.37724686352025, 52.34663551584025, 52.193578777440244, 52.10174473440024, 52.07113338672024, 52.04052203904024, 52.00991069136024, 51.88746530064024, 51.70379721456023, 51.64257451920023, 51.52012912848023, 51.27523834704022, 51.24462699936022, 51.21401565168022, 50.969124870240215, 50.938513522560214, 50.81606813184021, 50.69362274112021, 50.601788698080206, 50.4487319596802, 50.3875092643202, 50.2038411782402, 50.142618482880195, 50.05078443984019, 49.86711635376019, 49.714059615360185, 49.683448267680184, 49.65283692000018, 49.53039152928018, 49.49978018160018, 49.285500747840175, 49.22427805248017, 49.10183266176017, 49.07122131408017, 49.04060996640017, 49.00999861872017, 48.887553228000165, 48.76510783728016, 48.67327379424016, 48.64266244656016, 48.55082840352016, 48.520217055840156, 48.428383012800154, 48.39777166512015, 48.30593762208015, 48.21410357904015, 48.18349223136015]];
    var ellipseOneLng = [[-118.18167968, -117.66128676944011, -117.32456194496018, -116.83478038208028, -116.2837761238404, -115.97766264704046, -115.42665838880058, -114.8450427828807, -114.44709526304078, -114.20220448160083, -114.17159313392084, -113.8960910048009, -113.8654796571209, -113.19203000816104, -112.97775057440109, -112.94713922672109, -112.8859165313611, -112.85530518368111, -112.82469383600112, -112.73285979296114, -112.64102574992116, -112.57980305456117, -112.51858035920118, -112.48796901152119, -112.4573576638412, -112.4267463161612, -112.4267463161612, -112.51858035920118, -112.54919170688117, -112.67163709760115, -112.76347114064113, -113.13080731280105, -113.375698094241, -113.52875483264097, -114.72259739216072, -114.96748817360067, -115.05932221664065, -115.15115625968063, -115.24299030272061, -115.45726973648057, -116.2837761238404, -116.71233499136031, -118.18167968, -118.18167968, -118.48779315679994, -118.7020725905599, -119.00818606735983, -119.1306314580798, -119.77346975935967, -119.92652649775964, -120.1408059315196, -120.20202862687958, -120.75303288511947, -120.96731231887942, -121.21220310031937, -121.30403714335935, -121.39587118639933, -121.61015062015929, -121.73259601087926, -121.88565274927923, -122.06932083535919, -122.43665700751912, -122.46726835519911, -122.4978797028791, -122.83460452735903, -122.987661265759, -123.26316339487894, -123.32438609023893, -123.38560878559892, -123.4468314809589, -123.53866552399889, -123.69172226239886, -123.72233361007885, -123.75294495775884, -123.78355630543884, -123.90600169615881, -123.9672243915188, -124.12028112991877, -124.18150382527875, -124.27333786831873, -124.27333786831873, -124.21211517295875, -124.15089247759876, -124.05905843455878, -123.84477900079882, -123.59988821935887, -123.26316339487894, -123.23255204719895, -123.20194069951896, -123.17132935183896, -123.14071800415897, -123.11010665647898, -122.83460452735903, -122.68154778895907, -122.46726835519911, -122.28360026911915, -121.97748679231921, -121.91626409695922, -121.5489279247993, -121.18159175263938, -120.1408059315196, -119.98774919311963, -119.80408110703966, -119.58980167327971], [ -118.02862294160003, -117.81434350784008, -117.32456194496018, -117.2021165542402, -117.07967116352023, -116.7735576867203, -116.22255342848041, -115.7939945609605, -115.57971512720054, -115.21237895504062, -115.08993356432065, -114.93687682592068, -114.69198604448073, -114.66137469680073, -114.63076334912074, -114.60015200144075, -114.56954065376075, -114.53892930608076, -114.50831795840077, -114.47770661072077, -114.04914774320086, -113.77364561408092, -113.52875483264097, -113.46753213728098, -113.43692078960099, -113.406309441921, -113.34508674656101, -113.28386405120102, -113.25325270352103, -113.22264135584103, -113.22264135584103, -113.22264135584103, -113.25325270352103, -113.28386405120102, -113.34508674656101, -113.375698094241, -113.406309441921, -113.46753213728098, -113.55936618032096, -113.80425696176091, -114.07975909088086, -114.14098178624084, -114.20220448160083, -114.26342717696082, -114.3246498723208, -114.38587256768079, -114.66137469680073, -114.96748817360067, -115.51849243184056, -116.00827399472045, -116.16133073312042, -116.31438747152039, -116.49805555760035, -116.7429463390403, -118.42657046143995, -119.00818606735983, -119.55919032559972, -119.98774919311963, -120.04897188847961, -120.1101945838396, -120.17141727919959, -120.23263997455958, -120.29386266991956, -120.5693647990395, -120.72242153743947, -121.0897577095994, -121.45709388175932, -121.64076196783928, -121.67137331551928, -122.31421161679914, -122.46726835519911, -122.58971374591908, -122.74277048431905, -122.80399317967904, -122.86521587503903, -123.04888396111899, -123.26316339487894, -123.35499743791893, -123.5080541763189, -123.53866552399889, -123.59988821935887, -123.32438609023893, -122.95704991807901, -122.68154778895907, -122.46726835519911, -122.22237757375916, -122.13054353071918, -122.0387094876792, -121.88565274927923, -121.67137331551928, -121.61015062015929, -121.5489279247993, -121.48770522943931, -121.42648253407933, -121.15098040495938, -120.90608962351943, -120.53875345135951, -120.04897188847961], [ -117.99801159392004, -117.78373216016008, -117.63067542176012, -117.47761868336015, -117.35517329264017, -117.14089385888022, -116.7735576867203, -116.62050094832033, -115.64093782256053, -115.48788108416056, -115.27360165040061, -115.24299030272061, -115.12054491200064, -115.08993356432065, -115.05932221664065, -114.87565413056069, -114.78382008752071, -114.60015200144075, -114.41648391536079, -114.29403852464081, -114.26342717696082, -114.23281582928082, -114.20220448160083, -114.20220448160083, -114.17159313392084, -114.17159313392084, -114.17159313392084, -114.17159313392084, -114.17159313392084, -114.17159313392084, -114.17159313392084, -114.17159313392084, -114.20220448160083, -114.23281582928082, -114.26342717696082, -114.3246498723208, -114.3552612200008, -114.41648391536079, -114.50831795840077, -114.63076334912074, -114.93687682592068, -115.02871086896066, -115.12054491200064, -115.61032647488054, -116.2837761238404, -116.43683286224037, -116.58988960064033, -116.7735576867203, -118.36534776607996, -118.54901585215993, -119.03879741503982, -119.1306314580798, -119.22246550111979, -119.31429954415977, -119.46735628255973, -119.6204130209597, -119.68163571631969, -120.1101945838396, -120.17141727919959, -120.32447401759956, -120.5693647990395, -120.78364423279946, -120.90608962351943, -121.0591463619194, -121.27342579567936, -121.30403714335935, -121.33464849103935, -121.61015062015929, -121.64076196783928, -121.67137331551928, -121.85504140159924, -121.97748679231921, -122.06932083535919, -122.31421161679914, -122.43665700751912, -122.58971374591908, -122.62032509359908, -122.68154778895907, -122.77338183199905, -122.83460452735903, -122.89582722271902, -122.89582722271902, -122.77338183199905, -122.58971374591908, -122.55910239823909, -122.28360026911915, -121.88565274927923, -121.79381870623925, -121.64076196783928, -121.42648253407933, -121.36525983871934, -121.30403714335935, -121.24281444799936, -121.18159175263938, -120.5693647990395, -120.26325132223957, -120.1408059315196, -120.01836054079962, -119.86530380239965], [ -118.12045698464001, -117.90617755088006, -117.75312081248009, -117.60006407408012, -117.47761868336015, -117.01844846816024, -116.86539172976028, -116.43683286224037, -116.34499881920038, -116.2531647761604, -116.13071938544043, -115.57971512720054, -115.45726973648057, -115.42665838880058, -115.39604704112058, -115.39604704112058, -115.39604704112058, -115.39604704112058, -115.39604704112058, -115.39604704112058, -115.42665838880058, -115.42665838880058, -115.45726973648057, -115.48788108416056, -115.51849243184056, -115.54910377952055, -115.57971512720054, -115.61032647488054, -115.64093782256053, -115.67154917024052, -115.73277186560051, -115.82460590864049, -116.06949669008044, -116.19194208080042, -116.2837761238404, -116.65111229600032, -116.7429463390403, -116.83478038208028, -116.92661442512026, -117.04905981584024, -117.2327279019202, -118.18167968, -118.18167968, -118.39595911375996, -118.57962719983992, -118.7020725905599, -118.82451798127987, -119.28368819647977, -119.49796763023973, -119.55919032559972, -119.6204130209597, -119.68163571631969, -119.89591515007965, -120.17141727919959, -120.26325132223957, -120.41630806063954, -120.69181018975948, -120.72242153743947, -120.75303288511947, -120.96731231887942, -120.99792366655942, -121.0897577095994, -121.18159175263938, -121.24281444799936, -121.33464849103935, -121.36525983871934, -121.45709388175932, -121.48770522943931, -121.51831657711931, -121.5795392724793, -121.61015062015929, -121.61015062015929, -121.61015062015929, -121.61015062015929, -121.61015062015929, -121.5489279247993, -121.51831657711931, -121.42648253407933, -121.39587118639933, -121.36525983871934, -121.33464849103935, -121.18159175263938, -120.99792366655942, -120.84486692815945, -120.78364423279946, -120.5999761467195, -120.53875345135951, -120.32447401759956, -120.23263997455958, -119.95713784543963, -119.58980167327971, -119.43674493487974]];
    var path = [];
    for (i=0;i<points.length;i++)
            {
                path.push(new google.maps.LatLng(points[i].getLat(),points[i].getLng()));
		if(!(points[i].getLat() == ellipseOneLat[ellipseIndex][i]) && !(points[i].getLng() == ellipseOneLng[ellipseIndex][i]))
		    alert("Assert failed" + points[i].getLat() + ellipseOneLat[ellipseIndex][i]);
            };	    
    var shape = new google.maps.Polygon({
                paths: path,
                strokeColor: '#00000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillOpacity: 0,
                visible: true,
                clickable: false
                });
    var html = '$' + cost;            
    var pathInfo = new google.maps.InfoWindow();    
    pathInfo.setContent(html);
    pathInfo.setPosition(path[1]);
    pathInfo.open(map);
    shape.setMap(map);
    shapes.push(shape);
    pathInfos.push(pathInfo);
}

function assert(condition, message) { 
    if (!condition)
        throw Error("Assert failed" + (typeof message !== "undefined" ? ": " + message : ""));
};