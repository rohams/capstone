<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/mystyle.css">
<script src="scripts/script.js"></script>
<script src="scripts/testScript.js"></script>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript"
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxfWoChDI1GdE2uBRUcl17cbjocx6qcs0&sensor=false">
</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/jquery.csv-0.71.js"></script>
<script src="scripts/import.js"></script>
<script type="text/javascript">
            
    //****** global variables ******
    var CANADA = new google.maps.LatLng(54.36775852406841, -97.20703125); 
    var MAX_WEIGHT = 1000000;
    //all the visible stores on the map
    var stores = [];
    //all the imported stores from the first file
    var imported = [];
    //all the weights assigned to each store 
    var weights = [];
    //total weight assigned to each store for the selected cmd and weekday
    var tot_weights = [];
    //sub networks
    var subs = [];
    //all the consecutive conturs related to one drawing
    var shapes = [];
    var manual_add_id=0;
    var imp1 = false;
    var max_weight= 1;
    var norm_weight_ave= 1;
    var pathInfos = [];
    var AVE_ZINDEX = 200;
    var addAppend = false;
    var drawAppend = false;
    var optAppend = false;
    var DST_CST_RATIO = 0.001;
    var image1 = 'images/marker.png';
    var image2 = 'images/marker2.png';
    var geocoder;
    var aveMarker;
    var openedInfoWindow = null;
    var map;
    var sun=0,mon=0,tue=0,wed=0,thu=0,sat=0,fri=0;
    var w_ambient=0,w_frozen=0,w_perishable=0;
    var markers = [];

    // initialize the map    
function initialize() {
    geocoder = new google.maps.Geocoder();
    
    //map options
    var mapOptions = {
    center: CANADA,
    zoom: 4,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControl: true,
    mapTypeControlOptions: {
    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
    },
    streetViewControl: false,
    scaleControl: true,
    scaleControlOptions:{
    position: google.maps.ControlPosition.TOP_CENTER
    },
    panControl: true,
    panControlOptions: {
    position: google.maps.ControlPosition.RIGHT_TOP,
    },
    zoomControl: true,
    zoomControlOptions: {
    style: google.maps.ZoomControlStyle.DEFAULT,
    position: google.maps.ControlPosition.RIGHT_TOP
    }
    };
    map = new google.maps.Map(document.getElementById("map-canvas"),
                                  mapOptions);
                                  
 
    // Set info window anywhere the mouse click showing the LatLng of that point.
    var infoWindow = new google.maps.InfoWindow();
    google.maps.event.addListener(map, 'click', function(event) {
								  if (openedInfoWindow != null) {
									  openedInfoWindow.close();
								  }
                                  var dist = SumOfDistances(stores, event.latLng.lat(), event.latLng.lng());
                                  var cost = dist/DST_CST_RATIO;
                                  var html = '' + event.latLng +  "<br/>Cost: " + cost;
                                  infoWindow.setContent(html);
                                  infoWindow.setPosition(event.latLng);
                                  infoWindow.open(map);
                                  openedInfoWindow = infoWindow;
                                  });                             

    //set controls
    var control1 = document.createElement('DIV');
    control1.setAttribute("id", "control1");
    control1.style.padding = '5px';
    control1.style.border = '1px solid #000';
    control1.style.backgroundColor = 'white';
    control1.style.cursor = 'pointer';
    control1.innerHTML = 'Draw Ellipse';
    control1.title = 'draw cost based ellipse';
    control1.index = 1;

    // Control2 is not used.
    var control2 = document.createElement('DIV');
    control2.setAttribute("id", "control2");
    control2.style.padding = '5px';
    control2.style.border = '1px solid #000';
    control2.style.backgroundColor = 'white';
    control2.style.cursor = 'pointer';
    control2.innerHTML = 'Find Average';
    control2.title = 'mark the weighted average of the nodes';
    control2.index = 2;
    
    var control3 = document.createElement('DIV');
    control3.setAttribute("id", "control3");
    control3.style.padding = '5px';
    control3.style.border = '1px solid #000';
    control3.style.backgroundColor = 'white';
    control3.style.cursor = 'pointer';
    control3.innerHTML = 'Add a Store';
    control3.title = 'Add a new node to the network';
    control3.index = 3;

    var control4 = document.createElement('DIV');
    control4.setAttribute("id", "control4");
    control4.style.padding = '5px';
    control4.style.border = '1px solid #000';
    control4.style.backgroundColor = 'white';
    control4.style.cursor = 'pointer';
    control4.innerHTML = 'More Options';
    control4.title = 'add the next most optimal store';
    control4.index = 4;

    //draw ellipses
    google.maps.event.addDomListener(control1, 'click', function() {                        
                          if(!drawAppend){
                            if(optAppend){
                            //REMOVE OPTION ELEMENTs
                            var div = document.getElementById("options");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            optAppend = false;
                            }
                            }    
                            if(addAppend){
                            //REMOVE ADD A NODE ELEMENTS
                            var div = document.getElementById("add_node");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            addAppend = false;
                            }
                            }
                            // ADD NEW ELEMENTS
                            var button = document.createElement("BUTTON");
                            button.innerHTML = 'Enter';
                            button.id = "draw";
                            //LOADING
                            var textnode=document.createTextNode("Loading...");                         
                            var loadprt = document.getElementById("panel2");
                            button.onclick = function(){
                                document.getElementById("panel2").appendChild(textnode);
                                setTimeout(function() {                                   
                                    getEllipse(stores, map);
                                    loadprt.removeChild(textnode);
                                    
                                }, 0);
                              };
                            var node = document.createElement("DIV");
                            node.id = "draw_ellipse";
                            var input1 = document.createElement("input");
                            input1.type = "text";
                            input1.id = "cost";
                            input1.placeholder="initial cost, e.g. 500";                          
                            var input2 = document.createElement("input");
                            input2.type = "text";
                            input2.id = "coststep";
                            input2.placeholder="cost step, e.g. 50";
                            
                            node.appendChild(input1);
                            node.appendChild(input2);
                            node.appendChild(button);
                            document.getElementById("panel2").appendChild(node);
                            drawAppend = true;
                            }
                          
                      });
    
                                         
    // Add a store
    google.maps.event.addDomListener(control3, 'click', function() {
                            if(!addAppend){
                            if(drawAppend){
                            //REMOVE DRAW ELLIPSE ELEMENT
                            var div = document.getElementById("draw_ellipse");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            drawAppend = false;
                            }
                            }
                            if(optAppend){
                            //REMOVE OPTION ELEMENTs
                            var div = document.getElementById("options");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            optAppend = false;
                            }
                            }                           
                            //ADD NEW ELEMENTS
                            var node = document.createElement("DIV");
                            node.id = "add_node";
                            var button = document.createElement("BUTTON");
                            button.innerHTML = 'Add it';
                            button.id = "add";
                            button.onclick = function(){
                            addNode(map);
                              };
                            var lat = document.createElement("input");
                            lat.type = "text";
                            lat.placeholder="latitude";
                            lat.id = "lat";
                            var lng = document.createElement("input");
                            lng.type = "text";
                            lng.placeholder="longitude";
                            lng.id = "lng";
                            var weight = document.createElement("input");
                            weight.type = "text";
                            weight.placeholder="weight";
                            weight.id = "weight";
                            node.appendChild(lat);
                            node.appendChild(lng);
                            node.appendChild(weight);
                            node.appendChild(button);
                            document.getElementById("panel2").appendChild(node);
                            addAppend = true;
                            }
                                         });
                                          
    // More options
    google.maps.event.addDomListener(control4, 'click', function() {
                        if(!optAppend){
                            if(drawAppend){
                            //REMOVE DRAW ELLIPSE ELEMENT
                            var div = document.getElementById("draw_ellipse");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            drawAppend = false;
                            }
                            }
                            if(addAppend){
                            //REMOVE ADD A NODE ELEMENTS
                            var div = document.getElementById("add_node");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            addAppend = false;
                            }                                
                            }
                            //ADD NEW ELEMENTS
                            var node = document.createElement("DIV");
                            node.id = "options";
                            var button1 = document.createElement("BUTTON");
                            button1.innerHTML = "Find Weighted Average";                         
                            button1.id = "ave";
                            button1.onclick = function(){
                               var node = getWeightedAverage(stores); 
                            oldAveMarker = aveMarker;
                            aveMarker = new google.maps.Marker({                              
                                     position: new google.maps.LatLng(node.getLat(), node.getLng()),
                                     draggable: false,
                                     map: map,
                                     icon:image1,
                                     title: 'Weighted Average',
                                     zIndex: AVE_ZINDEX,
                                     animation: google.maps.Animation.DROP,
                                     clickable:false
                                     });
                                     if(typeof(oldAveMarker) != "undefined"){
                                          oldAveMarker.setMap(null);
                                     }   
                              };
                            var button2 = document.createElement("BUTTON");
                            button2.innerHTML = "The Node to Add ...";                         
                            button2.id = "add_next";
                             var bounds = new google.maps.LatLngBounds(
                             new google.maps.LatLng(49.490, -123.649),
                             new google.maps.LatLng(49.599, -123.443)
                            );
                            button2.onclick = function(){
                            var rectangle = new google.maps.Rectangle({
                                bounds: bounds,
                                draggable: true,
                                editable: true
                              });
                              rectangle.setMap(map);                        
                            };
                            var button3 = document.createElement("BUTTON");
                            button3.innerHTML = "The Node to Remove";                         
                            button3.id = "add_next";
                            button3.onclick = function(){
                            var node = getWeightedAverage(stores);                          
                              };
                            node.appendChild(button1);
                            node.appendChild(button2);
                            node.appendChild(button3);
                            document.getElementById("panel2").appendChild(node);
                            optAppend = true;
                        }

                                         });
                                         
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control1);                                     
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control3);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control4);
}


    google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body>
    <div id=inputs class=clearfix>
    <button type="button" id="imp_1" class="import-button" onclick="document.getElementById('files').click();">import 1</button>
    <div id="upload-wrap">
        <input type="file" id=files name=files[] />
    </div>
    </div>
    <div class="side-panel">
        <div id="panel3"></div>
        <div id="panel4"></div>
        <div id="panel5"></div>
        <div id="panel2"></div>
        
    </div>
    <div id="panel" style="margin-left: -52px"></div>
    <div id="map-canvas"></div>
    
</body>
</html>

