<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/mystyle.css">
<script src="scripts/script.js"></script>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript"
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxfWoChDI1GdE2uBRUcl17cbjocx6qcs0&sensor=false">
</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/jquery.csv-0.71.js"></script>
<script src="scripts/import.js"></script>
<script type="text/javascript">
            
    //global variables
    var CANADA = new google.maps.LatLng(54.36775852406841, -97.20703125);  
    var stores = []; 
    var subs = [];
    
    var AVE_ZINDEX = 200;
    var addAppend = false;
    var drawAppend = false;
    var image1 = 'images/marker.png';
    var image2 = 'images/marker2.png';
    var geocoder;
    var aveMarker;
    var markers = [];
                  
    // initialize the map    
function initialize() {
    geocoder = new google.maps.Geocoder();
    
    //map options
    var mapOptions = {
    center: CANADA,
    zoom: 4,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControl: true,
    mapTypeControlOptions: {
    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
    },
    streetViewControl: false,
    panControl: true,
    panControlOptions: {
    position: google.maps.ControlPosition.RIGHT_TOP,
    },
    zoomControl: true,
    zoomControlOptions: {
    style: google.maps.ZoomControlStyle.DEFAULT,
    position: google.maps.ControlPosition.RIGHT_TOP
    }
    };
    var map = new google.maps.Map(document.getElementById("map-canvas"),
                                  mapOptions);
                                  
      
        
   //set nodes
    google.maps.event.addListenerOnce(map, 'tilesloaded', addMarkers);

 
function addMarkers() {
    for (var i = 0; i < stores.length; i++) {
    var marker = new google.maps.Marker({
                                        position: new google.maps.LatLng(stores[i].getLat(), stores[i].getLng()),
                                        draggable: true,
                                        map: map
                                        });
        //TODO: use indexOf() instead
        google.maps.event.addListener(marker, 'dblclick', function(event) {
        for (var i = 0; i < markers.length; i++) {
            if (markers[i] == this) {
                this.setMap(null);
                stores[i] = null;
                markers[i] = null;
                break;
            }
        }
        });
        
        google.maps.event.addListener(marker, 'click', function(event) {
            infowindow = new google.maps.InfoWindow();
            var sub_name;
            var marker_id = markers.indexOf(this);
                if (marker_id==-1){
                infowindow.setContent( "<Store ID<br/>" + this.position);
                }
                else{
            sub_id = stores[marker_id].getSub();
            sub_name = subs[sub_id];
            infowindow.setContent( "Store ID <br/> Sub-network: " + sub_name + "<br/>" +this.position);
                }
            infowindow.open(map,this);
         });

        markers.push(marker);
        var ave_point = getAverage(stores);
        var new_center = new google.maps.LatLng(ave_point.getLat(), ave_point.getLng());
        map.setCenter(new_center);
        map.setZoom(6);
    }

}
    
    //set info window
    //TODO: should delete the previous opened info window
    var infoWindow = new google.maps.InfoWindow();
    google.maps.event.addListener(map, 'click', function(event) {
                                  var html = '' + event.latLng;
                                  infoWindow.setContent(html);
                                  infoWindow.setPosition(event.latLng);
                                  infoWindow.open(map);
                                  });
             

// Sets the map on all markers in the array.
function setAllMap(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}

// Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
  setAllMap(null);
}

// Shows any markers currently in the array.
function showMarkers() {
  setAllMap(map);
}

// Deletes all markers in the array by removing references to them.
function deleteMarkers() {
  clearMarkers();
  markers = [];
}                                
    

    //set controls
    var control1 = document.createElement('DIV');
    control1.setAttribute("id", "control1");
    control1.style.padding = '5px';
    control1.style.border = '1px solid #000';
    control1.style.backgroundColor = 'white';
    control1.style.cursor = 'pointer';
    control1.innerHTML = 'Draw Ellipse';
    control1.title = 'draw cost based ellipse';
    control1.index = 1;

    var control2 = document.createElement('DIV');
    control2.setAttribute("id", "control2");
    control2.style.padding = '5px';
    control2.style.border = '1px solid #000';
    control2.style.backgroundColor = 'white';
    control2.style.cursor = 'pointer';
    control2.innerHTML = 'Find Average';
    control2.title = 'mark the weighted average of the nodes';
    control2.index = 2;
    
    var control3 = document.createElement('DIV');
    control3.setAttribute("id", "control3");
    control3.style.padding = '5px';
    control3.style.border = '1px solid #000';
    control3.style.backgroundColor = 'white';
    control3.style.cursor = 'pointer';
    control3.innerHTML = 'Add a Store';
    control3.title = 'Add a new node to the network';
    control3.index = 3;

    var control4 = document.createElement('DIV');
    control4.setAttribute("id", "control4");
    control4.style.padding = '5px';
    control4.style.border = '1px solid #000';
    control4.style.backgroundColor = 'white';
    control4.style.cursor = 'pointer';
    control4.innerHTML = 'Sub-network';
    control4.title = 'select sub-network';
    control4.index = 4;

    //draw ellipses
    google.maps.event.addDomListener(control1, 'click', function() {                        
                          if(!drawAppend){
                            //REMOVE ADD A NODE ELEMENTS
                            var div = document.getElementById("add_node");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            addAppend = false;
                            }
                            // ADD NEW ELEMENTS
                            var button = document.createElement("BUTTON");
                            button.innerHTML = 'Enter';
                            button.id = "draw";
                            //LOADING
                            var textnode=document.createTextNode("Loading...");                         
                            var loadprt = document.getElementById("panel2");
                            button.onclick = function(){
                                document.getElementById("panel2").appendChild(textnode);
                                setTimeout(function() {                                   
                                    getEllipse(stores, map);
                                    loadprt.removeChild(textnode);
                                    
                                }, 0);
                              };
                            var node = document.createElement("DIV");
                            node.id = "draw_ellipse";
                            var input1 = document.createElement("input");
                            input1.type = "text";
                            input1.id = "cost";
                            input1.placeholder="initial cost, e.g. 500";                          
                            var input2 = document.createElement("input");
                            input2.type = "text";
                            input2.id = "coststep";
                            input2.placeholder="cost step, e.g. 50";
                            
                            node.appendChild(input1);
                            node.appendChild(input2);
                            node.appendChild(button);
                            document.getElementById("panel2").appendChild(node);
                            drawAppend = true;
                            }
                          
                      });
    
    //Average finder
    google.maps.event.addDomListener(control2, 'click', function() {
                            var node = getAverage(stores); 
                            oldAveMarker = aveMarker;
                            aveMarker = new google.maps.Marker({                              
                                     position: new google.maps.LatLng(node.getLat(), node.getLng()),
                                     draggable: false,
                                     map: map,
                                     icon:image1,
                                     title: 'Weighted Average',
                                     zIndex: AVE_ZINDEX,
                                     animation: google.maps.Animation.DROP
                                     });   
                            oldAveMarker.setMap(null);
                                         });
                                         
    // Add a store
    google.maps.event.addDomListener(control3, 'click', function() {
                            if(!addAppend){
                            //REMOVE DRAW ELLIPSE ELEMENT
                            var div = document.getElementById("draw_ellipse");
                            if (div!=null){
                            var parent = document.getElementById("panel2");
                            parent.removeChild(div);
                            drawAppend = false;
                            }
                            //ADD NEW ELEMENTS
                            var node = document.createElement("DIV");
                            node.id = "add_node";
                            var button = document.createElement("BUTTON");
                            button.innerHTML = 'Add it';
                            button.id = "add";
                            button.onclick = function(){
                            codeLatLong(map);
                              };
                            var lat = document.createElement("input");
                            lat.type = "text";
                            lat.placeholder="latitude";
                            lat.id = "lat";
                            var lng = document.createElement("input");
                            lng.type = "text";
                            lng.placeholder="longitude";
                            lng.id = "lng";
                            var weight = document.createElement("input");
                            weight.type = "text";
                            weight.placeholder="weight";
                            weight.id = "weight";
                            node.appendChild(lat);
                            node.appendChild(lng);
                            node.appendChild(weight);
                            node.appendChild(button);
                            document.getElementById("panel2").appendChild(node);                                                  
                            addAppend = true;
                            }
                                         });
                                          
    // Sub-network
    google.maps.event.addDomListener(control4, 'click', function() {
                           addMarkers();
                            
                                         });
                                         
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control1);                                     
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control2);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control3);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(control4);
    }


    google.maps.event.addDomListener(window, 'load', initialize);
    
</script>
</head>

<body>
    <div id=inputs class=clearfix>
    <button type="button" class="import-button" onclick="document.getElementById('files').click();"> Import </button>
    <div id="upload-wrap">
        <input type="file" id=files name=files[] multiple />
    </div>
    </div>
    <div id="panel2"></div> 
    <div id="panel" style="margin-left: -52px"></div>
    <div id="map-canvas"></div>
    
</body>
</html>

